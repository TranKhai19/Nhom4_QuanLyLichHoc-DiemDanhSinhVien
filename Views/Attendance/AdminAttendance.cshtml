@model List<StudentAttendanceMVC.Models.ClassSession>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h3>Phía Ban Quản Lý: Xem và Tải Điểm Danh</h3>
            </div>
            <div class="card-body">
                <p>Chọn lớp để xem và tải:</p>
                <select id="adminClassId" class="form-select mb-3">
                    <option value="">-- Chọn Lớp --</option>
                    @foreach (var cls in ViewBag.ClassSessions ?? Model)
                    {
                        <option value="@cls.Id">@cls.CourseName - @cls.Date.ToShortDateString()</option>
                    }
                </select>

                <div id="adminStudentList" style="display:none;">
                    <h4 id="adminClassTitle"></h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="adminTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tên Sinh Viên</th>
                                    <th>Trạng Thái</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <a id="downloadExcelBtn" class="btn btn-info" style="display:none;">Tải File Điểm Danh</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('adminClassId').addEventListener('change', function () {
        var classId = this.value;
        if (classId) {
            document.getElementById('adminStudentList').style.display = 'block';
            var tbody = document.querySelector('#adminTable tbody');
            tbody.innerHTML = '<tr><td colspan="2" class="text-center">Đang tải...</td></tr>'; // Loading message
            $.get('@Url.Action("GetClassStudents", "Attendance")', { classId: classId }, function (data) {
                if (data.success) {
                    document.getElementById('adminClassTitle').innerText = 'Điểm Danh Lớp: ' + data.className + ' (' + data.date + ')';
                    tbody.innerHTML = '';
                    data.students.forEach(student => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${student.name}</td>
                                <td><span class="badge ${student.attended == 'Có' ? 'bg-success' : 'bg-danger'}">${student.attended}</span></td>
                            </tr>
                        `;
                    });
                    document.getElementById('downloadExcelBtn').href = '@Url.Action("DownloadAttendanceExcel", "Attendance")' + '?classId=' + classId;
                    document.getElementById('downloadExcelBtn').style.display = 'block';
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Không có dữ liệu.</td></tr>';
                    document.getElementById('downloadExcelBtn').style.display = 'none';
                }
            }).fail(function () {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
            });
        } else {
            document.getElementById('adminStudentList').style.display = 'none';
        }
    });
</script>